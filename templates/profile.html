{% extends "base.html" %}

{% block title %}{{ user.username }} - Profile - Chatter{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Profile Header -->
    <div class="glass-effect rounded-3 mb-4" style="border: 1px solid var(--border-light);">
        <!-- Cover Photo -->
        <div class="position-relative">
            <div class="profile-cover" style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;"></div>
            
            <!-- Profile Picture -->
            <div class="position-absolute" style="bottom: -60px; left: 20px;">
                <img src="{{ url_for('static', filename='uploads/profiles/' + user.profile_picture) }}" 
                     class="rounded-circle border-4 border-dark" 
                     style="width: 120px; height: 120px; object-fit: cover; border: 4px solid var(--background-color);"
                     onerror="this.src='https://ui-avatars.com/api/?name={{ user.username }}&background=1d9bf0&color=fff'">
            </div>
            
            <!-- Edit Profile Button (for own profile) -->
            {% if current_user.id == user.id %}
            <div class="position-absolute" style="bottom: -50px; right: 20px;">
                <a href="{{ url_for('edit_profile') }}" class="btn btn-outline-light">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </a>
            </div>
            {% endif %}
        </div>
        
        <!-- Profile Info -->
        <div class="p-4" style="margin-top: 60px;">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2 class="fw-bold mb-1">{{ user.username }}</h2>
                    {% if user.is_verified %}
                    <span class="verified-badge me-1"><i class="fas fa-check-circle"></i> Verified</span>
                    {% endif %}
                    {% if user.is_admin %}
                    <span class="admin-badge">Admin</span>
                    {% endif %}
                    
                    <p class="text-muted mb-2">@{{ user.username }}</p>
                    
                    {% if user.bio %}
                    <p class="mb-3">{{ user.bio }}</p>
                    {% endif %}
                    
                    {% if user.location %}
                    <p class="text-muted mb-1">
                        <i class="fas fa-map-marker-alt me-2"></i>{{ user.location }}
                    </p>
                    {% endif %}
                    
                    {% if user.website %}
                    <p class="text-muted mb-1">
                        <i class="fas fa-link me-2"></i>
                        <a href="{{ user.website }}" target="_blank" class="text-decoration-none" style="color: var(--primary-color);">
                            {{ user.website|truncate(30) }}
                        </a>
                    </p>
                    {% endif %}
                    
                    <p class="text-muted mb-0">
                        <i class="fas fa-calendar me-2"></i>
                        Joined {{ user.created_at.strftime('%B %Y') }}
                    </p>
                </div>
                
                <!-- Follow/Message/More buttons -->
                <div class="d-flex gap-2">
                    {% if current_user.id != user.id %}
                        {% if current_user.has_blocked(user) %}
                        <button class="btn btn-outline-danger unblock-btn" data-user-id="{{ user.id }}">
                            <i class="fas fa-ban me-2"></i>Unblock
                        </button>
                        {% else %}
                        <button class="btn {% if current_user.is_following(user) %}btn-primary{% else %}btn-outline-primary{% endif %} follow-btn" 
                                data-user-id="{{ user.id }}">
                            {% if current_user.is_following(user) %}
                                <i class="fas fa-user-check me-2"></i>Following
                            {% else %}
                                <i class="fas fa-user-plus me-2"></i>Follow
                            {% endif %}
                        </button>
                        
                        <a href="{{ url_for('conversation', user_id=user.id) }}" class="btn btn-outline-light">
                            <i class="fas fa-envelope"></i>
                        </a>
                        {% endif %}
                    {% endif %}
                    
                    <!-- More options dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-light" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            {% if current_user.id != user.id %}
                            <li>
                                <button class="dropdown-item block-btn" data-user-id="{{ user.id }}">
                                    <i class="fas fa-ban me-2"></i>
                                    {% if current_user.has_blocked(user) %}Unblock User{% else %}Block User{% endif %}
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item report-btn" data-user-id="{{ user.id }}">
                                    <i class="fas fa-flag me-2"></i>Report User
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            {% endif %}
                            <li>
                                <a class="dropdown-item" href="{{ url_for('profile_followers', username=user.username) }}">
                                    <i class="fas fa-users me-2"></i>View Followers
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('profile_following', username=user.username) }}">
                                    <i class="fas fa-user-friends me-2"></i>View Following
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="d-flex gap-4 mt-4">
                <a href="{{ url_for('profile_following', username=user.username) }}" class="text-decoration-none">
                    <span class="fw-bold">{{ total_following }}</span>
                    <span class="text-muted">Following</span>
                </a>
                <a href="{{ url_for('profile_followers', username=user.username) }}" class="text-decoration-none">
                    <span class="fw-bold">{{ total_followers }}</span>
                    <span class="text-muted">Followers</span>
                </a>
                <a href="#" class="text-decoration-none">
                    <span class="fw-bold">{{ total_likes }}</span>
                    <span class="text-muted">Likes</span>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Pinned Post (if exists) -->
    {% if pinned_post %}
    <div class="glass-effect rounded-3 mb-4" style="border: 2px solid var(--primary-color); position: relative;">
        <div class="position-absolute" style="top: 10px; right: 10px;">
            <span class="badge" style="background: var(--primary-color);">
                <i class="fas fa-thumbtack me-1"></i>Pinned
            </span>
        </div>
        <div class="p-3">
            {% include 'components/post_card.html' %}
        </div>
    </div>
    {% endif %}
    
    <!-- Profile Tabs -->
    <nav class="mb-4">
        <div class="nav nav-tabs" id="profileTabs" role="tablist">
            <button class="nav-link active" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts" type="button">
                <i class="fas fa-comment me-2"></i>Posts
            </button>
            <button class="nav-link" id="replies-tab" data-bs-toggle="tab" data-bs-target="#replies" type="button">
                <i class="fas fa-comments me-2"></i>Replies
            </button>
            <button class="nav-link" id="media-tab" data-bs-toggle="tab" data-bs-target="#media" type="button">
                <i class="fas fa-image me-2"></i>Media
            </button>
            <button class="nav-link" id="likes-tab" data-bs-toggle="tab" data-bs-target="#likes" type="button">
                <i class="fas fa-heart me-2"></i>Likes
            </button>
        </div>
    </nav>
    
    <!-- Tab Content -->
    <div class="tab-content" id="profileTabContent">
        <!-- Posts Tab -->
        <div class="tab-pane fade show active" id="posts">
            {% if posts %}
                {% for post in posts %}
                    {% include 'components/post_card.html' %}
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No posts yet</h5>
                    <p class="text-muted">When {{ user.username }} posts, you'll see it here.</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Other tabs (simplified for now) -->
        <div class="tab-pane fade" id="replies">
            <div class="text-center py-5">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No replies yet</h5>
            </div>
        </div>
        
        <div class="tab-pane fade" id="media">
            <div class="row g-2">
                {% for post in posts if post.image %}
                <div class="col-md-4">
                    <img src="{{ url_for('static', filename='uploads/posts/' + post.image) }}" 
                         class="img-fluid rounded-3" style="aspect-ratio: 1; object-fit: cover; cursor: pointer;"
                         onclick="window.location.href='{{ url_for('view_post', post_id=post.id) }}'">
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="tab-pane fade" id="likes">
            <div class="text-center py-5">
                <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No likes yet</h5>
            </div>
        </div>
    </div>
</div>

<script>
    // Follow/Unfollow functionality
    document.querySelectorAll('.follow-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const userId = this.dataset.userId;
            const originalText = this.innerHTML;
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
            
            try {
                const response = await fetch(`/follow/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'followed') {
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                    this.innerHTML = '<i class="fas fa-user-check me-2"></i>Following';
                } else {
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-outline-primary');
                    this.innerHTML = '<i class="fas fa-user-plus me-2"></i>Follow';
                }
                
                // Show toast notification
                showToast(data.message || 'Action completed', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                this.innerHTML = originalText;
                showToast('An error occurred', 'danger');
            } finally {
                this.disabled = false;
            }
        });
    });
    
    // Block/Unblock functionality
    document.querySelectorAll('.block-btn, .unblock-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const userId = this.dataset.userId;
            const isUnblock = this.classList.contains('unblock-btn');
            
            if (!confirm(isUnblock ? 'Unblock this user?' : 'Block this user?')) return;
            
            const originalText = this.innerHTML;
            this.disabled = true;
            
            try {
                const response = await fetch(`/block/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'blocked') {
                    this.classList.add('btn-danger');
                    this.classList.remove('btn-outline-danger');
                    this.innerHTML = '<i class="fas fa-ban me-2"></i>Unblock';
                    showToast('User blocked', 'success');
                } else {
                    this.classList.remove('btn-danger');
                    this.classList.add('btn-outline-danger');
                    this.innerHTML = '<i class="fas fa-ban me-2"></i>Block';
                    showToast('User unblocked', 'success');
                }
                
            } catch (error) {
                console.error('Error:', error);
                this.innerHTML = originalText;
                showToast('An error occurred', 'danger');
            } finally {
                this.disabled = false;
            }
        });
    });
</script>
{% endblock %}