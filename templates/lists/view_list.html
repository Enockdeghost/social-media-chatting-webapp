{% extends "base.html" %}

{% block title %}{{ user_list.name }} - List - Chatter{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- List Header -->
            <div class="glass-effect rounded-3 mb-4" style="border: 1px solid var(--border-light);">
                <div class="p-4">
                    <!-- Back Button -->
                    <div class="mb-3">
                        <a href="{{ url_for('lists') }}" class="text-decoration-none d-inline-flex align-items-center">
                            <i class="fas fa-arrow-left me-2"></i>
                            <span>Back to Lists</span>
                        </a>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="fw-bold mb-2">{{ user_list.name }}</h2>
                            {% if user_list.is_private %}
                            <span class="badge bg-secondary mb-2">
                                <i class="fas fa-lock me-1"></i>Private List
                            </span>
                            {% else %}
                            <span class="badge bg-success mb-2">
                                <i class="fas fa-globe me-1"></i>Public List
                            </span>
                            {% endif %}
                            
                            <div class="d-flex align-items-center mb-3">
                                <a href="{{ url_for('profile', username=user_list.creator.username) }}" class="text-decoration-none d-flex align-items-center">
                                    <img src="{{ url_for('static', filename='uploads/profiles/' + user_list.creator.profile_picture) }}" 
                                         class="avatar-sm me-2"
                                         onerror="this.src='https://ui-avatars.com/api/?name={{ user_list.creator.username }}&background=1d9bf0&color=fff'">
                                    <span class="fw-bold">@{{ user_list.creator.username }}</span>
                                </a>
                                <span class="text-muted mx-2">â€¢</span>
                                <span class="text-muted">{{ user_list.created_at|time_ago }}</span>
                            </div>
                            
                            {% if user_list.description %}
                            <p class="mb-0">{{ user_list.description }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            {% if is_owner %}
                            <a href="{{ url_for('edit_list', list_id=user_list.id) }}" class="btn btn-outline-light">
                                <i class="fas fa-edit me-2"></i>Edit
                            </a>
                            {% endif %}
                            
                            <button class="btn {% if is_subscribed %}btn-success{% else %}btn-outline-primary{% endif %} subscribe-btn" 
                                    data-list-id="{{ user_list.id }}">
                                {% if is_subscribed %}
                                    <i class="fas fa-check me-2"></i>Subscribed
                                {% else %}
                                    <i class="fas fa-plus me-2"></i>Subscribe
                                {% endif %}
                            </button>
                            
                            <a href="{{ url_for('list_feed', list_id=user_list.id) }}" class="btn btn-primary">
                                <i class="fas fa-rss me-2"></i>View Feed
                            </a>
                        </div>
                    </div>
                    
                    <!-- Stats -->
                    <div class="d-flex gap-4 mt-4">
                        <div>
                            <span class="fw-bold">{{ members|length }}</span>
                            <span class="text-muted">Members</span>
                        </div>
                        <div>
                            <span class="fw-bold">{{ subscriber_count }}</span>
                            <span class="text-muted">Subscribers</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- List Content Tabs -->
            <nav class="mb-4">
                <div class="nav nav-tabs" id="listViewTabs" role="tablist">
                    <button class="nav-link active" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button">
                        <i class="fas fa-users me-2"></i>Members
                    </button>
                    {% if is_owner %}
                    <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button">
                        <i class="fas fa-user-plus me-2"></i>Manage Members
                    </button>
                    {% endif %}
                </div>
            </nav>
            
            <!-- Tab Content -->
            <div class="tab-content" id="listViewTabContent">
                <!-- Members Tab -->
                <div class="tab-pane fade show active" id="members">
                    {% if members %}
                        <div class="row g-3">
                            {% for member in members %}
                            <div class="col-md-6">
                                <div class="glass-effect rounded-3 p-3 hover-lift" style="border: 1px solid var(--border-light);">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <img src="{{ url_for('static', filename='uploads/profiles/' + member.profile_picture) }}" 
                                                 class="avatar-sm me-3"
                                                 onerror="this.src='https://ui-avatars.com/api/?name={{ member.username }}&background=1d9bf0&color=fff'">
                                            <div>
                                                <h6 class="fw-bold mb-0">{{ member.username }}</h6>
                                                <small class="text-muted">{{ member.followers.count() }} followers</small>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <a href="{{ url_for('profile', username=member.username) }}" class="btn btn-sm btn-outline-light">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if is_owner %}
                                            <button class="btn btn-sm btn-outline-danger remove-member-btn" 
                                                    data-list-id="{{ user_list.id }}" 
                                                    data-user-id="{{ member.id }}">
                                                <i class="fas fa-user-minus"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No members in this list</h5>
                            {% if is_owner %}
                            <p class="text-muted">Add members to get started.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Manage Members Tab (for owners) -->
                {% if is_owner %}
                <div class="tab-pane fade" id="manage">
                    <div class="glass-effect rounded-3 p-4" style="border: 1px solid var(--border-light);">
                        <h5 class="fw-bold mb-3">Add Members</h5>
                        
                        <form id="add-member-form" data-list-id="{{ user_list.id }}">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="username-search" 
                                       placeholder="Search users to add..." 
                                       autocomplete="off">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-plus me-2"></i>Add
                                </button>
                            </div>
                        </form>
                        
                        <!-- Search Results -->
                        <div id="search-results" class="mt-3"></div>
                        
                        <!-- Existing Members -->
                        <div id="list-members" class="mt-4">
                            <h6 class="fw-bold mb-3">Current Members ({{ members|length }})</h6>
                            <div class="list-group">
                                {% for member in members %}
                                <div class="list-group-item d-flex justify-content-between align-items-center" 
                                     id="member-{{ member.id }}">
                                    <div class="d-flex align-items-center">
                                        <img src="{{ url_for('static', filename='uploads/profiles/' + member.profile_picture) }}" 
                                             class="avatar-sm me-2"
                                             onerror="this.src='https://ui-avatars.com/api/?name={{ member.username }}&background=1d9bf0&color=fff'">
                                        <div>
                                            <a href="{{ url_for('profile', username=member.username) }}" class="text-decoration-none">
                                                {{ member.username }}
                                            </a>
                                            <br>
                                            <small class="text-muted">{{ member.followers.count() }} followers</small>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger remove-member-btn" 
                                            data-user-id="{{ member.id }}">
                                        Remove
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Subscribe/Unsubscribe functionality
    document.querySelector('.subscribe-btn').addEventListener('click', async function() {
        const listId = this.dataset.listId;
        const isSubscribed = this.classList.contains('btn-success');
        
        try {
            const response = await fetch(`/lists/${listId}/subscribe`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'subscribed') {
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-success');
                this.innerHTML = '<i class="fas fa-check me-2"></i>Subscribed';
                showToast('Subscribed to list!', 'success');
            } else {
                this.classList.remove('btn-success');
                this.classList.add('btn-outline-primary');
                this.innerHTML = '<i class="fas fa-plus me-2"></i>Subscribe';
                showToast('Unsubscribed from list', 'info');
            }
            
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred', 'danger');
        }
    });
    
    // Add member functionality (for list owners)
    {% if is_owner %}
    const addMemberForm = document.getElementById('add-member-form');
    const usernameSearch = document.getElementById('username-search');
    const searchResults = document.getElementById('search-results');
    
    // Search users as you type
    usernameSearch.addEventListener('input', async function() {
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }
        
        try {
            const response = await fetch(`/api/lists/search_users?q=${encodeURIComponent(query)}&list_id={{ user_list.id }}`);
            const data = await response.json();
            
            if (data.users.length > 0) {
                let html = '<div class="list-group">';
                data.users.forEach(user => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="${user.profile_picture}" class="avatar-sm me-2" 
                                     onerror="this.src='https://ui-avatars.com/api/?name=${user.username}&background=1d9bf0&color=fff'">
                                <div>
                                    <strong>${user.username}</strong>
                                    <br>
                                    <small class="text-muted">${user.bio || 'No bio'}</small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary add-member-btn" 
                                    data-username="${user.username}">
                                Add
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                searchResults.innerHTML = html;
            } else {
                searchResults.innerHTML = '<p class="text-muted">No users found</p>';
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
    
    // Add member button click
    searchResults.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-member-btn')) {
            const username = e.target.dataset.username;
            addMember(username);
        }
    });
    
    // Form submit
    addMemberForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const username = usernameSearch.value.trim();
        if (username) {
            addMember(username);
        }
    });
    
    async function addMember(username) {
        try {
            const formData = new FormData();
            formData.append('username', username);
            
            const response = await fetch(`/lists/{{ user_list.id }}/add_member`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Add to members list
                const memberHtml = `
                    <div class="list-group-item d-flex justify-content-between align-items-center" id="member-${data.member.id}">
                        <div class="d-flex align-items-center">
                            <img src="${data.member.profile_picture}" class="avatar-sm me-2"
                                 onerror="this.src='https://ui-avatars.com/api/?name=${data.member.username}&background=1d9bf0&color=fff'">
                            <div>
                                <a href="/profile/${data.member.username}" class="text-decoration-none">
                                    ${data.member.username}
                                </a>
                                <br>
                                <small class="text-muted">0 followers</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger remove-member-btn" 
                                data-user-id="${data.member.id}">
                            Remove
                        </button>
                    </div>
                `;
                
                document.getElementById('list-members').querySelector('.list-group').insertAdjacentHTML('beforeend', memberHtml);
                usernameSearch.value = '';
                searchResults.innerHTML = '';
                showToast('Member added successfully!', 'success');
            } else {
                showToast(data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred', 'danger');
        }
    }
    
    // Remove member functionality
    document.getElementById('list-members').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-member-btn')) {
            const userId = e.target.dataset.userId;
            removeMember(userId, e.target);
        }
    });
    
    async function removeMember(userId, button) {
        if (!confirm('Remove this member from the list?')) return;
        
        try {
            const response = await fetch(`/lists/{{ user_list.id }}/remove_member/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById(`member-${userId}`).remove();
                showToast('Member removed', 'success');
            } else {
                showToast(data.error, 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred', 'danger');
        }
    }
    {% endif %}
</script>
{% endblock %}