<!-- Post Card Component -->
<div class="post-card" id="post-{{ post.id }}">
    <div class="d-flex align-items-start">
        <!-- Avatar -->
        <a href="{{ url_for('profile', username=post.author.username) }}" class="text-decoration-none me-3">
            <img src="{{ url_for('static', filename='uploads/profiles/' + post.author.profile_picture) }}" 
                 class="avatar"
                 onerror="this.src='https://ui-avatars.com/api/?name={{ post.author.username }}&background=1d9bf0&color=fff'">
        </a>
        
        <!-- Post Content -->
        <div class="flex-grow-1">
            <!-- Post Header -->
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <a href="{{ url_for('profile', username=post.author.username) }}" class="text-decoration-none fw-bold">
                        {{ post.author.username }}
                    </a>
                    {% if post.author.is_verified %}
                    <i class="fas fa-check-circle verified-badge"></i>
                    {% endif %}
                    {% if post.author.is_admin %}
                    <span class="admin-badge">Admin</span>
                    {% endif %}
                    <span class="text-muted ms-2">Â· {{ post.created_at|time_ago }}</span>
                    
                    <!-- Post privacy/pin indicators -->
                    {% if post.is_pinned_by(post.author) %}
                    <span class="badge ms-2" style="background: var(--primary-color);">
                        <i class="fas fa-thumbtack me-1"></i>Pinned
                    </span>
                    {% endif %}
                </div>
                
                <!-- Post Actions Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        {% if current_user.id == post.author.id %}
                        <li>
                            <button class="dropdown-item pin-post-btn" data-post-id="{{ post.id }}">
                                <i class="fas fa-thumbtack me-2"></i>
                                {% if post.is_pinned_by(current_user) %}Unpin Post{% else %}Pin to Profile{% endif %}
                            </button>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('edit_post', post_id=post.id) }}">
                                <i class="fas fa-edit me-2"></i>Edit Post
                            </a>
                        </li>
                        <li>
                            <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" 
                                  onsubmit="return confirm('Are you sure you want to delete this post?');">
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="fas fa-trash me-2"></i>Delete Post
                                </button>
                            </form>
                        </li>
                        {% else %}
                        <li>
                            <button class="dropdown-item bookmark-post-btn" data-post-id="{{ post.id }}">
                                <i class="fas fa-bookmark me-2"></i>
                                {% if post in current_user.bookmarked_posts %}Remove Bookmark{% else %}Bookmark{% endif %}
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item report-btn" data-post-id="{{ post.id }}" data-user-id="{{ post.author.id }}">
                                <i class="fas fa-flag me-2"></i>Report Post
                            </button>
                        </li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button class="dropdown-item" onclick="navigator.clipboard.writeText(window.location.origin + '{{ url_for('view_post', post_id=post.id) }}')">
                                <i class="fas fa-link me-2"></i>Copy Link
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Post Text -->
            <div class="mb-3">
                <p class="mb-2" style="white-space: pre-wrap;">{{ post.content|process_content|safe }}</p>
                
                <!-- Post Image -->
                {% if post.image %}
                <div class="mt-3">
                    <img src="{{ url_for('static', filename='uploads/posts/' + post.image) }}" 
                         class="img-fluid rounded-3" style="max-height: 400px; object-fit: cover; cursor: pointer;"
                         onclick="window.location.href='{{ url_for('view_post', post_id=post.id) }}'">
                </div>
                {% endif %}
            </div>
            
            <!-- Post Actions -->
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex gap-4">
                    <!-- Comment -->
                    <a href="{{ url_for('view_post', post_id=post.id) }}" class="action-btn comment-btn">
                        <i class="far fa-comment"></i>
                        <span class="ms-1">{{ post.comment_count() }}</span>
                    </a>
                    
                    <!-- Like -->
                    <button class="action-btn like-btn {% if post.likes.filter_by(user_id=current_user.id).first() %}liked{% endif %}" 
                            data-post-id="{{ post.id }}">
                        <i class="{% if post.likes.filter_by(user_id=current_user.id).first() %}fas{% else %}far{% endif %} fa-heart"></i>
                        <span class="ms-1 like-count">{{ post.like_count() }}</span>
                    </button>
                    
                    <!-- Bookmark -->
                    <button class="action-btn bookmark-btn" data-post-id="{{ post.id }}">
                        <i class="far fa-bookmark"></i>
                    </button>
                </div>
                
                <!-- View Post Link -->
                <a href="{{ url_for('view_post', post_id=post.id) }}" class="text-muted small">
                    View post <i class="fas fa-external-link-alt ms-1"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Like functionality
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const postId = this.dataset.postId;
            const icon = this.querySelector('i');
            const countSpan = this.querySelector('.like-count');
            
            try {
                const response = await fetch(`/post/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'liked') {
                    this.classList.add('liked');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                } else {
                    this.classList.remove('liked');
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                }
                
                countSpan.textContent = data.count;
                
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });
    
    // Pin/Unpin functionality
    document.querySelectorAll('.pin-post-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const postId = this.dataset.postId;
            const isPinned = this.innerHTML.includes('Unpin');
            
            if (isPinned && !confirm('Unpin this post from your profile?')) return;
            
            try {
                const response = await fetch(`/post/${postId}/pin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'pinned') {
                    this.innerHTML = '<i class="fas fa-thumbtack me-2"></i>Unpin Post';
                    showToast('Post pinned to your profile!', 'success');
                } else {
                    this.innerHTML = '<i class="fas fa-thumbtack me-2"></i>Pin to Profile';
                    showToast('Post unpinned from your profile', 'info');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred', 'danger');
            }
        });
    });
    
    // Bookmark functionality
    document.querySelectorAll('.bookmark-btn, .bookmark-post-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const postId = this.dataset.postId;
            const isBookmarkBtn = this.classList.contains('bookmark-post-btn');
            
            try {
                const response = await fetch(`/post/${postId}/bookmark`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (isBookmarkBtn) {
                    if (data.status === 'bookmarked') {
                        this.innerHTML = '<i class="fas fa-bookmark me-2"></i>Remove Bookmark';
                    } else {
                        this.innerHTML = '<i class="fas fa-bookmark me-2"></i>Bookmark';
                    }
                }
                
                showToast(data.status === 'bookmarked' ? 'Post bookmarked!' : 'Bookmark removed', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred', 'danger');
            }
        });
    });
</script>